on:
  push:
    branches: [master]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      DOTNET_NOLOGO: true
    steps:
    - name: Check out PowerApps-Language-Tooling
      uses: actions/checkout@master
      with:
        repository: microsoft/PowerApps-Language-Tooling
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: 'PowerApps-Language-Tooling'

    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '3.1.x'

    - run: dotnet --info

    - name: Build and test (win)
      run: ./PowerApps-Language-Tooling/build ci
      shell: cmd
      if: ${{ runner.os == 'Windows' }} 
      
      ## Only difference here is not forcing cmd
    - name: Build and test (!win)
      run: dotnet run --project "./PowerApps-Language-Tooling/targets/targets.csproj" -- "ci"
      if: ${{ runner.os != 'Windows' }}

    - name: Check out Self
      uses: actions/checkout@master
      with:
        path: 'src'
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

    - name: PowerApps-Language-Tooling
      uses: canastro/copy-file-action@master
      with:
        source: "./PowerApps-Language-Tooling/bin/Debug"
        target: "./src/bin"

#   test:
#     name: Test
# #    needs: build
#     strategy:
#       matrix:
#         os: [macos-latest, ubuntu-latest, windows-latest]
#     runs-on: ${{ matrix.os }}
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
#       - name: Setup Node.js
#         uses: actions/setup-node@v1
#         with:
#           node-version: 14
#       - name: Install dependencies
#         run: npm install
#       - name: Run headless test
#         uses: GabrielBB/xvfb-action@v1.0
#         with:
#           run: npm test

  # publish:
  #   name: Release and publish
  #   needs: test
  #   runs-on: ubuntu-18.04
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: 14
  #     - name: Install dependencies
  #       run: npm install
  #     - name: Release
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
  #         NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  #       run: npx semantic-release
  #     # - name: Vscode release plugin
  #     #   uses: JCofman/vscodeaction@master
  #     #   env:
  #     #     PUBLISHER_TOKEN: ${{ secrets.PUBLISHER_TOKEN }}
  #     #   with:
  #     #     args: publish -p $PUBLISHER_TOKEN 
